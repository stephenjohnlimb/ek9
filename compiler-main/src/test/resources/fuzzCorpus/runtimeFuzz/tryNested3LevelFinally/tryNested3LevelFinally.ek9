#!ek9
<?-
  Runtime fuzz test: Nested try-finally propagates to outer catch.

  Tests that when inner try-finally throws, the inner finally executes
  then exception propagates to outer catch and is absorbed.

  NOTE: Bug discovered - adding outer finally causes exception to still
  propagate after catch. Tracking in EXCEPTION_HANDLING_BUGS.md.

  Structure: try { try { THROW } finally } catch
-?>
defines module fuzz.runtime.try.nested.threelevel

  defines program

    TryNested3LevelFinally()
      stdout <- Stdout()

      try
        stdout.println("Level 1: start")
        try
          stdout.println("Level 2: start")
          stdout.println("Level 2: about to throw")
          ex <- Exception("Deep exception")
          throw ex
        finally
          stdout.println("Level 2 finally: cleanup")
      catch
        -> e as Exception
        stdout.println("Level 1 catch: caught deep exception")

      stdout.println("Done")

//EOF
