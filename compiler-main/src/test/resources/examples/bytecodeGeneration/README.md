# EK9 Bytecode Tests

Bytecode generation and execution tests for the EK9 compiler.

## Overview

These tests validate EK9 bytecode generation and execution through two mechanisms:

1. **JUnit In-JVM Tests** (Primary) - Fast, parallel execution within the test JVM
2. **E2E Binary Test** (helloWorld only) - Validates the full ek9 wrapper binary chain

## JUnit In-JVM Tests

The primary testing approach uses `AbstractExecutableBytecodeTest` which:
- Compiles EK9 source via the compiler
- Loads generated bytecode via URLClassLoader
- Executes programs within the test JVM
- Captures stdout via thread-local delegation for parallel safety
- Compares output against expected files

### Test Structure

Each test directory contains:

- `*.ek9` - EK9 source file
- `commandline_arg_<case>.txt` - Command-line arguments (one per line)
- `expected_case_<case>.txt` - Expected stdout output

For no-argument tests:
- `expected_output.txt` - Expected stdout output (single case)

### Running Tests

```bash
# Run all bytecode tests
mvn test -Dtest="**/bytecode/*Test" -pl compiler-main

# Run specific test
mvn test -Dtest=SimpleSwitchLiteralTest -pl compiler-main

# Run full test suite
mvn test -pl compiler-main
```

### Adding New Tests

1. Create test directory with EK9 source
2. Add `commandline_arg_<case>.txt` and `expected_case_<case>.txt` files
3. Create Java test class extending `AbstractExecutableBytecodeTest`:

```java
class MyNewTest extends AbstractExecutableBytecodeTest {
    public MyNewTest() {
        super("/examples/bytecodeGeneration/myNewTest",
            "bytecode.test.mynewtest",
            "MyNewTest",
            List.of(new SymbolCountCheck("bytecode.test.mynewtest", 1)));
    }
}
```

## E2E Binary Test

The `helloWorld/test.sh` validates the full binary chain:
- ek9 wrapper binary invocation
- Compiler JAR linkage
- Native execution

```bash
cd compiler-main/src/test/resources/examples/bytecodeGeneration/helloWorld
./test.sh
```

This is the only shell-based test, kept to validate the binary toolchain.

## Architecture

### Key Classes

- `AbstractExecutableBytecodeTest` - Base class for executable bytecode tests
- `BytecodeExecutor` - Executes compiled programs in-JVM
- `ThreadLocalPrintStream` - Enables parallel-safe stdout capture

### Thread-Local Output Capture

To enable parallel test execution:
1. `System.out` is replaced with a delegating PrintStream at class load time
2. Each test thread registers its own capture buffer
3. EK9 programs write to Stdout normally
4. Output is captured per-thread without interference

## See Also

- Java test classes: `compiler-main/src/test/java/org/ek9lang/compiler/bytecode/`
- IR generation tests: `compiler-main/src/test/resources/examples/irGeneration/`
