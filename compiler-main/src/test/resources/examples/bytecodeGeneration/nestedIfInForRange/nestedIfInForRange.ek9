#!ek9
<?-
  Minimal test to reproduce for-range loop bytecode bug.
  Tests: for-range with single nested if statement inside loop body.

  This is the SMALLEST example that should expose the jump target bug.
  If this works, the bug is more subtle. If this fails, we've isolated it.

  Expected Bytecode Structure:
  - Three-way dispatch (ascending/descending/equal)
  - Equal case: single iteration at line 171, nested IF jumps to 244
  - Ascending case: loop at line 247, nested IF jumps to 359 (ascending increment)
  - Descending case: loop at line 376, nested IF jumps to 488 (descending increment)

  Key Fix: Increment labels MUST be created AFTER entering dispatch case context
  to ensure unique labels (for_increment_ascending_scope_3 vs for_increment_descending_scope_3)
-?>
defines module bytecode.test.nested

  defines program

    @BYTECODE: CODE_GENERATION_AGGREGATES: TYPE: "bytecode.test.nested::NestedIfInForRange":`public class bytecode.test.nested.NestedIfInForRange {
  static {};
    Code:
         0: return

  private void i_init();
    Code:
         0: return

  public bytecode.test.nested.NestedIfInForRange();
    Code:
         0: aload_0
         1: invokespecial #CP                 // Method java/lang/Object."<init>":()V
         4: aload_0
         5: invokevirtual #CP                 // Method i_init:()V
         8: return

  public void _main();
    Code:
         0: aconst_null
         1: astore_1
         2: new           #CP                 // class org/ek9/lang/Stdout
         5: dup
         6: invokespecial #CP                 // Method org/ek9/lang/Stdout."<init>":()V
         9: astore_2
        10: aload_2
        11: astore_1
        12: aconst_null
        13: astore_3
        14: iconst_1
        15: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        18: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        21: astore        4
        23: aload         4
        25: astore        5
        27: iconst_5
        28: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        31: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        34: astore        6
        36: aload         6
        38: astore        7
        40: aload         5
        42: invokevirtual #CP                 // Method org/ek9/lang/Integer._isSet:()Lorg/ek9/lang/Boolean;
        45: astore        8
        47: aload         8
        49: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
        52: istore        9
        54: iload         9
        56: ifne          69
        59: new           #CP                 // class java/lang/AssertionError
        62: dup
        63: ldc           #CP                 // String For-range \'start\' value must be set
        65: invokespecial #CP                 // Method java/lang/AssertionError."<init>":(Ljava/lang/Object;)V
        68: athrow
        69: aload         7
        71: invokevirtual #CP                 // Method org/ek9/lang/Integer._isSet:()Lorg/ek9/lang/Boolean;
        74: astore        10
        76: aload         10
        78: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
        81: istore        11
        83: iload         11
        85: ifne          98
        88: new           #CP                 // class java/lang/AssertionError
        91: dup
        92: ldc           #CP                 // String For-range \'end\' value must be set
        94: invokespecial #CP                 // Method java/lang/AssertionError."<init>":(Ljava/lang/Object;)V
        97: athrow
        98: aload         5
       100: aload         7
       102: invokevirtual #CP                 // Method org/ek9/lang/Integer._cmp:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       105: astore        12
       107: aload         5
       109: astore        13
       111: iconst_0
       112: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       115: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       118: astore        14
       120: aload         12
       122: aload         14
       124: invokevirtual #CP                 // Method org/ek9/lang/Integer._lt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       127: astore        15
       129: aload         15
       131: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       134: istore        16
       136: iload         16
       138: ifne          247
       141: iconst_0
       142: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       145: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       148: astore        17
       150: aload         12
       152: aload         17
       154: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       157: astore        18
       159: aload         18
       161: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       164: istore        19
       166: iload         19
       168: ifne          376
       171: aload         13
       173: astore_3
       174: aload_1
       175: astore        20
       177: ldc           #CP                 // String Iteration
       179: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       182: astore        21
       184: aload         20
       186: aload         21
       188: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       191: aload_3
       192: astore        22
       194: iconst_2
       195: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       198: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       201: astore        23
       203: aload         22
       205: aload         23
       207: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       210: astore        24
       212: aload         24
       214: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       217: istore        25
       219: iload         25
       221: ifeq          244
       224: aload_1
       225: astore        26
       227: ldc           #CP                 // String Big
       229: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       232: astore        27
       234: aload         26
       236: aload         27
       238: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       241: goto          244
       244: goto          502
       247: aload         13
       249: aload         7
       251: invokevirtual #CP                 // Method org/ek9/lang/Integer._cmp:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       254: astore        28
       256: iconst_0
       257: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       260: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       263: astore        29
       265: aload         28
       267: aload         29
       269: invokevirtual #CP                 // Method org/ek9/lang/Integer._lteq:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       272: astore        30
       274: aload         30
       276: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       279: istore        31
       281: iload         31
       283: ifeq          502
       286: aload         13
       288: astore_3
       289: aload_1
       290: astore        20
       292: ldc           #CP                 // String Iteration
       294: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       297: astore        21
       299: aload         20
       301: aload         21
       303: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       306: aload_3
       307: astore        22
       309: iconst_2
       310: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       313: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       316: astore        23
       318: aload         22
       320: aload         23
       322: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       325: astore        24
       327: aload         24
       329: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       332: istore        25
       334: iload         25
       336: ifeq          359
       339: aload_1
       340: astore        26
       342: ldc           #CP                 // String Big
       344: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       347: astore        27
       349: aload         26
       351: aload         27
       353: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       356: goto          359
       359: aload         13
       361: invokevirtual #CP                 // Method org/ek9/lang/Integer._inc:()Lorg/ek9/lang/Integer;
       364: astore        32
       366: aload         32
       368: astore        13
       370: goto          247
       373: nop
       374: nop
       375: athrow
       376: aload         13
       378: aload         7
       380: invokevirtual #CP                 // Method org/ek9/lang/Integer._cmp:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       383: astore        33
       385: iconst_0
       386: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       389: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       392: astore        34
       394: aload         33
       396: aload         34
       398: invokevirtual #CP                 // Method org/ek9/lang/Integer._gteq:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       401: astore        35
       403: aload         35
       405: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       408: istore        36
       410: iload         36
       412: ifeq          502
       415: aload         13
       417: astore_3
       418: aload_1
       419: astore        20
       421: ldc           #CP                 // String Iteration
       423: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       426: astore        21
       428: aload         20
       430: aload         21
       432: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       435: aload_3
       436: astore        22
       438: iconst_2
       439: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       442: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       445: astore        23
       447: aload         22
       449: aload         23
       451: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       454: astore        24
       456: aload         24
       458: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       461: istore        25
       463: iload         25
       465: ifeq          488
       468: aload_1
       469: astore        26
       471: ldc           #CP                 // String Big
       473: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       476: astore        27
       478: aload         26
       480: aload         27
       482: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       485: goto          488
       488: aload         13
       490: invokevirtual #CP                 // Method org/ek9/lang/Integer._dec:()Lorg/ek9/lang/Integer;
       493: astore        37
       495: aload         37
       497: astore        13
       499: goto          376
       502: aload_1
       503: astore        38
       505: ldc           #CP                 // String Done
       507: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       510: astore        39
       512: aload         38
       514: aload         39
       516: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       519: return
}`

    NestedIfInForRange()
      stdout <- Stdout()

      for i in 1 ... 5
        stdout.println("Iteration")

        if i > 2
          stdout.println("Big")

      stdout.println("Done")

//EOF
