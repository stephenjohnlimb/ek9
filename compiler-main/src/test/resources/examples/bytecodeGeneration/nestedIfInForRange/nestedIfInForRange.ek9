#!ek9
<?-
  Minimal test to reproduce for-range loop bytecode bug.
  Tests: for-range with single nested if statement inside loop body.

  This is the SMALLEST example that should expose the jump target bug.
  If this works, the bug is more subtle. If this fails, we've isolated it.

  Expected Bytecode Structure:
  - Three-way dispatch (ascending/descending/equal)
  - Equal case: single iteration at line 171, nested IF jumps to 244
  - Ascending case: loop at line 247, nested IF jumps to 359 (ascending increment)
  - Descending case: loop at line 376, nested IF jumps to 488 (descending increment)

  Key Fix: Increment labels MUST be created AFTER entering dispatch case context
  to ensure unique labels (for_increment_ascending_scope_3 vs for_increment_descending_scope_3)
-?>
defines module bytecode.test.nested

  defines program

    @BYTECODE: CODE_GENERATION_AGGREGATES: TYPE: "bytecode.test.nested::NestedIfInForRange":`public class bytecode.test.nested.NestedIfInForRange {
  public bytecode.test.nested.NestedIfInForRange();
    Code:
         0: aload_0
         1: invokespecial #CP                  // Method java/lang/Object."<init>":()V
         4: aload_0
         5: invokevirtual #CP                 // Method i_init:()V
         8: return

  public void _main();
    Code:
         0: aconst_null
         1: astore_1
         2: new           #CP                 // class org/ek9/lang/Stdout
         5: dup
         6: invokespecial #CP                 // Method org/ek9/lang/Stdout."<init>":()V
         9: astore_2
        10: aload_2
        11: astore_1
        12: aconst_null
        13: astore_3
        14: iconst_1
        15: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        18: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        21: astore        4
        23: aload         4
        25: astore        5
        27: iconst_5
        28: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        31: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        34: astore        6
        36: aload         6
        38: astore        7
        40: aload         5
        42: invokevirtual #CP                 // Method org/ek9/lang/Integer._isSet:()Lorg/ek9/lang/Boolean;
        45: astore        8
        47: aload         8
        49: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
        52: istore        9
        54: iload         9
        56: ifne          69
        59: new           #CP                 // class java/lang/AssertionError
        62: dup
        63: ldc           #CP                 // String For-range \'start\' value must be set
        65: invokespecial #CP                 // Method java/lang/AssertionError."<init>":(Ljava/lang/Object;)V
        68: athrow
        69: aload         7
        71: invokevirtual #CP                 // Method org/ek9/lang/Integer._isSet:()Lorg/ek9/lang/Boolean;
        74: astore        10
        76: aload         10
        78: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
        81: istore        11
        83: iload         11
        85: ifne          98
        88: new           #CP                 // class java/lang/AssertionError
        91: dup
        92: ldc           #CP                 // String For-range \'end\' value must be set
        94: invokespecial #CP                 // Method java/lang/AssertionError."<init>":(Ljava/lang/Object;)V
        97: athrow
        98: aload         5
       100: aload         7
       102: invokevirtual #CP                 // Method org/ek9/lang/Integer._cmp:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       105: astore        12
       107: aload         5
       109: astore        13
       111: iconst_0
       112: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       115: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       118: astore        14
       120: aload         12
       122: aload         14
       124: invokevirtual #CP                 // Method org/ek9/lang/Integer._lt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       127: astore        15
       129: aload         15
       131: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       134: istore        16
       136: iload         16
       138: ifne          277
       141: iconst_0
       142: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       145: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       148: astore        17
       150: aload         12
       152: aload         17
       154: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       157: astore        18
       159: aload         18
       161: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       164: istore        19
       166: iload         19
       168: ifne          406
       171: iconst_0
       172: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       175: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       178: astore        20
       180: aload         12
       182: aload         20
       184: invokevirtual #CP                 // Method org/ek9/lang/Integer._eq:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       187: astore        21
       189: aload         21
       191: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       194: istore        22
       196: iload         22
       198: ifeq          532
       201: aload         13
       203: astore_3
       204: aload_1
       205: astore        23
       207: ldc           #CP                 // String Iteration
       209: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       212: astore        24
       214: aload         23
       216: aload         24
       218: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       221: aload_3
       222: astore        25
       224: iconst_2
       225: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       228: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       231: astore        26
       233: aload         25
       235: aload         26
       237: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       240: astore        27
       242: aload         27
       244: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       247: istore        28
       249: iload         28
       251: ifeq          274
       254: aload_1
       255: astore        29
       257: ldc           #CP                 // String Big
       259: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       262: astore        30
       264: aload         29
       266: aload         30
       268: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       271: goto          274
       274: goto          532
       277: aload         13
       279: aload         7
       281: invokevirtual #CP                 // Method org/ek9/lang/Integer._cmp:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       284: astore        31
       286: iconst_0
       287: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       290: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       293: astore        32
       295: aload         31
       297: aload         32
       299: invokevirtual #CP                 // Method org/ek9/lang/Integer._lteq:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       302: astore        33
       304: aload         33
       306: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       309: istore        34
       311: iload         34
       313: ifeq          532
       316: aload         13
       318: astore_3
       319: aload_1
       320: astore        23
       322: ldc           #CP                 // String Iteration
       324: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       327: astore        24
       329: aload         23
       331: aload         24
       333: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       336: aload_3
       337: astore        25
       339: iconst_2
       340: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       343: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       346: astore        26
       348: aload         25
       350: aload         26
       352: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       355: astore        27
       357: aload         27
       359: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       362: istore        28
       364: iload         28
       366: ifeq          389
       369: aload_1
       370: astore        29
       372: ldc           #CP                 // String Big
       374: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       377: astore        30
       379: aload         29
       381: aload         30
       383: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       386: goto          389
       389: aload         13
       391: invokevirtual #CP                 // Method org/ek9/lang/Integer._inc:()Lorg/ek9/lang/Integer;
       394: astore        35
       396: aload         35
       398: astore        13
       400: goto          277
       403: nop
       404: nop
       405: athrow
       406: aload         13
       408: aload         7
       410: invokevirtual #CP                 // Method org/ek9/lang/Integer._cmp:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       413: astore        36
       415: iconst_0
       416: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       419: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       422: astore        37
       424: aload         36
       426: aload         37
       428: invokevirtual #CP                 // Method org/ek9/lang/Integer._gteq:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       431: astore        38
       433: aload         38
       435: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       438: istore        39
       440: iload         39
       442: ifeq          532
       445: aload         13
       447: astore_3
       448: aload_1
       449: astore        23
       451: ldc           #CP                 // String Iteration
       453: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       456: astore        24
       458: aload         23
       460: aload         24
       462: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       465: aload_3
       466: astore        25
       468: iconst_2
       469: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       472: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       475: astore        26
       477: aload         25
       479: aload         26
       481: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       484: astore        27
       486: aload         27
       488: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       491: istore        28
       493: iload         28
       495: ifeq          518
       498: aload_1
       499: astore        29
       501: ldc           #CP                 // String Big
       503: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       506: astore        30
       508: aload         29
       510: aload         30
       512: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       515: goto          518
       518: aload         13
       520: invokevirtual #CP                 // Method org/ek9/lang/Integer._dec:()Lorg/ek9/lang/Integer;
       523: astore        40
       525: aload         40
       527: astore        13
       529: goto          406
       532: aload_1
       533: astore        41
       535: ldc           #CP                 // String Done
       537: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       540: astore        42
       542: aload         41
       544: aload         42
       546: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       549: return

  static {};
    Code:
         0: return

  private void i_init();
    Code:
         0: return
}`

    NestedIfInForRange()
      stdout <- Stdout()

      for i in 1 ... 5
        stdout.println("Iteration")

        if i > 2
          stdout.println("Big")

      stdout.println("Done")

//EOF
