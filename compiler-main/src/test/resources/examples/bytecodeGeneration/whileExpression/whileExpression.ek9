#!ek9
<?-
  Bytecode test for while expression form.
  Expression form: result: while guard <- value with condition
  The while returns a value through the rtn variable (accumulator pattern).

  This program computes the sum of integers from 0 to limit-1.
  For limit=5: sum = 0 + 1 + 2 + 3 + 4 = 10
-?>
defines module bytecode.test

  defines program

    @BYTECODE: CODE_GENERATION_AGGREGATES: TYPE: "bytecode.test::WhileExpression": `public class bytecode.test.WhileExpression {
  public void _main(org.ek9.lang.Integer);
    Code:
         0: aconst_null
         1: astore_2
         2: new           #CP                  // class org/ek9/lang/Stdout
         5: dup
         6: invokespecial #CP                 // Method org/ek9/lang/Stdout."<init>":()V
         9: astore_3
        10: aload_3
        11: astore_2
        12: aconst_null
        13: astore        4
        15: aconst_null
        16: astore        5
        18: iconst_0
        19: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        22: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        25: astore        6
        27: aload         6
        29: astore        5
        31: aload         5
        33: ifnull        40
        36: iconst_0
        37: goto          41
        40: iconst_1
        41: istore        7
        43: iload         7
        45: ifeq          60
        48: invokestatic  #CP                 // Method org/ek9/lang/Boolean._ofFalse:()Lorg/ek9/lang/Boolean;
        51: astore        8
        53: aload         8
        55: astore        9
        57: goto          75
        60: aload         5
        62: astore        10
        64: aload         10
        66: invokevirtual #CP                 // Method org/ek9/lang/Integer._isSet:()Lorg/ek9/lang/Boolean;
        69: astore        11
        71: aload         11
        73: astore        9
        75: aload         9
        77: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
        80: istore        12
        82: aconst_null
        83: astore        13
        85: iconst_0
        86: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        89: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        92: astore        14
        94: aload         14
        96: astore        13
        98: iload         12
       100: ifeq          184
       103: aload         5
       105: astore        15
       107: aload_1
       108: astore        16
       110: aload         15
       112: aload         16
       114: invokevirtual #CP                 // Method org/ek9/lang/Integer._lt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       117: astore        17
       119: aload         17
       121: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       124: istore        18
       126: iload         18
       128: ifeq          181
       131: aload         13
       133: astore        19
       135: aload         5
       137: astore        20
       139: aload         19
       141: aload         20
       143: invokevirtual #CP                 // Method org/ek9/lang/Integer._add:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       146: astore        21
       148: aload         21
       150: astore        13
       152: aload         5
       154: astore        22
       156: iconst_1
       157: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       160: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       163: astore        23
       165: aload         22
       167: aload         23
       169: invokevirtual #CP                 // Method org/ek9/lang/Integer._add:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       172: astore        24
       174: aload         24
       176: astore        5
       178: goto          103
       181: goto          184
       184: aload         13
       186: astore        25
       188: aload         25
       190: astore        4
       192: aload_2
       193: astore        26
       195: aload         4
       197: astore        27
       199: aload         26
       201: aload         27
       203: invokeinterface #CP,  2           // InterfaceMethod org/ek9/lang/StringOutput.println:(Lorg/ek9/lang/Any;)V
       208: aload_2
       209: astore        28
       211: ldc           #CP                 // String Done
       213: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       216: astore        29
       218: aload         28
       220: aload         29
       222: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       225: return

  static {};
    Code:
         0: return

  private void i_init();
    Code:
         0: return

  public bytecode.test.WhileExpression();
    Code:
         0: aload_0
         1: invokespecial #CP                 // Method java/lang/Object."<init>":()V
         4: aload_0
         5: invokevirtual #CP                 // Method i_init:()V
         8: return
}`

    WhileExpression()
      -> limit as Integer

      stdout <- Stdout()

      // While expression that accumulates sum from 0 to limit-1
      result <- while counter <- 0 with counter < limit
        <- rtn <- 0
        rtn: rtn + counter
        counter: counter + 1

      // Print the result (accumulated sum)
      stdout.println(result)

      // Always print to verify program continues
      stdout.println("Done")

//EOF
