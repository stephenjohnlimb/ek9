#!ek9
<?-
  Bytecode test for while loop with guarded assignment (?=).
  Guarded assignment checks the RIGHT side (expression result) before assigning.
  Pattern: while existingVar ?= expr then condition
-?>
defines module bytecode.test.whileguardedassign

  defines program

    @BYTECODE: CODE_GENERATION_AGGREGATES: TYPE: "bytecode.test.whileguardedassign::WhileGuardedAssignment": `public class bytecode.test.whileguardedassign.WhileGuardedAssignment {
  static {};
    Code:
         0: return

  private void i_init();
    Code:
         0: return

  public bytecode.test.whileguardedassign.WhileGuardedAssignment();
    Code:
         0: aload_0
         1: invokespecial #CP                 // Method java/lang/Object."<init>":()V
         4: aload_0
         5: invokevirtual #CP                 // Method i_init:()V
         8: return

  public void _main(org.ek9.lang.Integer);
    Code:
         0: aconst_null
         1: astore_2
         2: new           #CP                 // class org/ek9/lang/Stdout
         5: dup
         6: invokespecial #CP                 // Method org/ek9/lang/Stdout."<init>":()V
         9: astore_3
        10: aload_3
        11: astore_2
        12: aconst_null
        13: astore        4
        15: iconst_0
        16: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        19: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        22: astore        5
        24: aload         5
        26: astore        4
        28: aconst_null
        29: astore        6
        31: new           #CP                 // class org/ek9/lang/Integer
        34: dup
        35: invokespecial #CP                 // Method org/ek9/lang/Integer."<init>":()V
        38: astore        7
        40: aload         7
        42: astore        6
        44: aconst_null
        45: astore        8
        47: new           #CP                 // class org/ek9/lang/Integer
        50: dup
        51: invokespecial #CP                 // Method org/ek9/lang/Integer."<init>":()V
        54: astore        9
        56: aload         9
        58: astore        8
        60: aload_1
        61: astore        10
        63: iconst_0
        64: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        67: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        70: astore        11
        72: aload         10
        74: aload         11
        76: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
        79: astore        12
        81: aload         12
        83: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
        86: istore        13
        88: iload         13
        90: ifeq          114
        93: aload_1
        94: astore        14
        96: new           #CP                 // class org/ek9/lang/Integer
        99: dup
       100: aload         14
       102: invokespecial #CP                 // Method org/ek9/lang/Integer."<init>":(Lorg/ek9/lang/Integer;)V
       105: astore        15
       107: aload         15
       109: astore        8
       111: goto          114
       114: aload         8
       116: astore        16
       118: aload         16
       120: astore        6
       122: aload         6
       124: ifnull        131
       127: iconst_0
       128: goto          132
       131: iconst_1
       132: istore        17
       134: iload         17
       136: ifeq          151
       139: invokestatic  #CP                 // Method org/ek9/lang/Boolean._ofFalse:()Lorg/ek9/lang/Boolean;
       142: astore        18
       144: aload         18
       146: astore        19
       148: goto          166
       151: aload         6
       153: astore        20
       155: aload         20
       157: invokevirtual #CP                 // Method org/ek9/lang/Integer._isSet:()Lorg/ek9/lang/Boolean;
       160: astore        21
       162: aload         21
       164: astore        19
       166: aload         19
       168: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       171: istore        22
       173: iload         22
       175: ifeq          276
       178: aload         6
       180: astore        23
       182: aload         4
       184: astore        24
       186: aload         23
       188: aload         24
       190: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       193: astore        25
       195: aload         25
       197: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       200: istore        26
       202: iload         26
       204: ifeq          273
       207: aload         4
       209: astore        27
       211: iconst_1
       212: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       215: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       218: astore        28
       220: aload         27
       222: aload         28
       224: invokevirtual #CP                 // Method org/ek9/lang/Integer._add:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       227: astore        29
       229: aload         29
       231: astore        4
       233: aload_2
       234: astore        30
       236: ldc           #CP                 // String Loop:
       238: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       241: astore        31
       243: aload         4
       245: astore        32
       247: aload         32
       249: invokevirtual #CP                 // Method org/ek9/lang/Integer._string:()Lorg/ek9/lang/String;
       252: astore        33
       254: aload         31
       256: aload         33
       258: invokevirtual #CP                 // Method org/ek9/lang/String._add:(Lorg/ek9/lang/String;)Lorg/ek9/lang/String;
       261: astore        34
       263: aload         30
       265: aload         34
       267: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       270: goto          178
       273: goto          276
       276: aload_2
       277: astore        35
       279: ldc           #CP                 // String Final:
       281: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       284: astore        36
       286: aload         4
       288: astore        37
       290: aload         37
       292: invokevirtual #CP                 // Method org/ek9/lang/Integer._string:()Lorg/ek9/lang/String;
       295: astore        38
       297: aload         36
       299: aload         38
       301: invokevirtual #CP                 // Method org/ek9/lang/String._add:(Lorg/ek9/lang/String;)Lorg/ek9/lang/String;
       304: astore        39
       306: aload         35
       308: aload         39
       310: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       313: return
}`

    WhileGuardedAssignment()
      -> input as Integer

      stdout <- Stdout()
      counter <- 0

      // Declare variable first (unset)
      value <- Integer()

      // Compute the expression value inline (simulating function result)
      exprValue <- Integer()
      if input > 0
        exprValue: Integer(input)

      // Guarded assignment (?=) - checks if assigned value is set
      // Guard entry check happens ONCE, condition on each iteration
      while value ?= exprValue then value > counter
        counter := counter + 1
        stdout.println("Loop: " + $counter)

      stdout.println("Final: " + $counter)

//EOF
