#!ek9
<?-
  Bytecode test for for-range expression form.
  Expression form: result <- for i in start ... end <- rtn <- initialValue
  The for-range returns a value through the rtn variable (accumulator pattern).

  This program computes the sum of integers from 1 to limit.
  For limit=5: sum = 1 + 2 + 3 + 4 + 5 = 15
-?>
defines module bytecode.test.forrangeexpr

  defines program

    @BYTECODE: CODE_GENERATION_AGGREGATES: TYPE: "bytecode.test.forrangeexpr::ForRangeExpression": `public class bytecode.test.forrangeexpr.ForRangeExpression {
  static {};
    Code:
         0: return

  private void i_init();
    Code:
         0: return

  public bytecode.test.forrangeexpr.ForRangeExpression();
    Code:
         0: aload_0
         1: invokespecial #CP                 // Method java/lang/Object."<init>":()V
         4: aload_0
         5: invokevirtual #CP                 // Method i_init:()V
         8: return

  public void _main(org.ek9.lang.Integer);
    Code:
         0: aconst_null
         1: astore_2
         2: new           #CP                 // class org/ek9/lang/Stdout
         5: dup
         6: invokespecial #CP                 // Method org/ek9/lang/Stdout."<init>":()V
         9: astore_3
        10: aload_3
        11: astore_2
        12: aconst_null
        13: astore        4
        15: aconst_null
        16: astore        5
        18: iconst_0
        19: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        22: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        25: astore        6
        27: aload         6
        29: astore        5
        31: aconst_null
        32: astore        7
        34: iconst_1
        35: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
        38: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
        41: astore        8
        43: aload         8
        45: astore        9
        47: aload_1
        48: astore        10
        50: aload         10
        52: astore        11
        54: aload         9
        56: invokevirtual #CP                 // Method org/ek9/lang/Integer._isSet:()Lorg/ek9/lang/Boolean;
        59: astore        12
        61: aload         12
        63: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
        66: istore        13
        68: iload         13
        70: ifne          83
        73: new           #CP                 // class java/lang/AssertionError
        76: dup
        77: ldc           #CP                 // String For-range \'start\' value must be set
        79: invokespecial #CP                 // Method java/lang/AssertionError."<init>":(Ljava/lang/Object;)V
        82: athrow
        83: aload         11
        85: invokevirtual #CP                 // Method org/ek9/lang/Integer._isSet:()Lorg/ek9/lang/Boolean;
        88: astore        14
        90: aload         14
        92: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
        95: istore        15
        97: iload         15
        99: ifne          112
       102: new           #CP                 // class java/lang/AssertionError
       105: dup
       106: ldc           #CP                 // String For-range \'end\' value must be set
       108: invokespecial #CP                 // Method java/lang/AssertionError."<init>":(Ljava/lang/Object;)V
       111: athrow
       112: aload         9
       114: aload         11
       116: invokevirtual #CP                 // Method org/ek9/lang/Integer._cmp:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       119: astore        16
       121: aload         9
       123: astore        17
       125: iconst_0
       126: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       129: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       132: astore        18
       134: aload         16
       136: aload         18
       138: invokevirtual #CP                 // Method org/ek9/lang/Integer._lt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       141: astore        19
       143: aload         19
       145: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       148: istore        20
       150: iload         20
       152: ifne          213
       155: iconst_0
       156: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       159: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       162: astore        21
       164: aload         16
       166: aload         21
       168: invokevirtual #CP                 // Method org/ek9/lang/Integer._gt:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       171: astore        22
       173: aload         22
       175: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       178: istore        23
       180: iload         23
       182: ifne          294
       185: aload         17
       187: astore        7
       189: aload         5
       191: astore        24
       193: aload         7
       195: astore        25
       197: aload         24
       199: aload         25
       201: invokevirtual #CP                 // Method org/ek9/lang/Integer._add:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       204: astore        26
       206: aload         26
       208: astore        5
       210: goto          372
       213: aload         17
       215: aload         11
       217: invokevirtual #CP                 // Method org/ek9/lang/Integer._cmp:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       220: astore        27
       222: iconst_0
       223: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       226: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       229: astore        28
       231: aload         27
       233: aload         28
       235: invokevirtual #CP                 // Method org/ek9/lang/Integer._lteq:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       238: astore        29
       240: aload         29
       242: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       245: istore        30
       247: iload         30
       249: ifeq          372
       252: aload         17
       254: astore        7
       256: aload         5
       258: astore        24
       260: aload         7
       262: astore        25
       264: aload         24
       266: aload         25
       268: invokevirtual #CP                 // Method org/ek9/lang/Integer._add:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       271: astore        26
       273: aload         26
       275: astore        5
       277: aload         17
       279: invokevirtual #CP                 // Method org/ek9/lang/Integer._inc:()Lorg/ek9/lang/Integer;
       282: astore        31
       284: aload         31
       286: astore        17
       288: goto          213
       291: nop
       292: nop
       293: athrow
       294: aload         17
       296: aload         11
       298: invokevirtual #CP                 // Method org/ek9/lang/Integer._cmp:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       301: astore        32
       303: iconst_0
       304: invokestatic  #CP                 // Method java/lang/Integer.toString:(I)Ljava/lang/String;
       307: invokestatic  #CP                 // Method org/ek9/lang/Integer._of:(Ljava/lang/String;)Lorg/ek9/lang/Integer;
       310: astore        33
       312: aload         32
       314: aload         33
       316: invokevirtual #CP                 // Method org/ek9/lang/Integer._gteq:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Boolean;
       319: astore        34
       321: aload         34
       323: invokevirtual #CP                 // Method org/ek9/lang/Boolean._true:()Z
       326: istore        35
       328: iload         35
       330: ifeq          372
       333: aload         17
       335: astore        7
       337: aload         5
       339: astore        24
       341: aload         7
       343: astore        25
       345: aload         24
       347: aload         25
       349: invokevirtual #CP                 // Method org/ek9/lang/Integer._add:(Lorg/ek9/lang/Integer;)Lorg/ek9/lang/Integer;
       352: astore        26
       354: aload         26
       356: astore        5
       358: aload         17
       360: invokevirtual #CP                 // Method org/ek9/lang/Integer._dec:()Lorg/ek9/lang/Integer;
       363: astore        36
       365: aload         36
       367: astore        17
       369: goto          294
       372: aload         5
       374: astore        37
       376: aload         37
       378: astore        4
       380: aload_2
       381: astore        38
       383: aload         4
       385: astore        39
       387: aload         38
       389: aload         39
       391: invokeinterface #CP,  2           // InterfaceMethod org/ek9/lang/StringOutput.println:(Lorg/ek9/lang/Any;)V
       396: aload_2
       397: astore        40
       399: ldc           #CP                 // String Done
       401: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       404: astore        41
       406: aload         40
       408: aload         41
       410: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       413: return
}`

    ForRangeExpression()
      -> limit as Integer

      stdout <- Stdout()

      // For-range expression that accumulates sum from 1 to limit
      result <- for i in 1 ... limit
        <- rtn <- 0
        rtn: rtn + i

      // Print the result (accumulated sum)
      stdout.println(result)

      // Always print to verify program continues
      stdout.println("Done")

//EOF
