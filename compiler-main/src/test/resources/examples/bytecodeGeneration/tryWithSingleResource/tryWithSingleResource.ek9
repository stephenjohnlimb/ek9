#!ek9
<?-
  Bytecode test for try-with-resources (single resource).
  Resource declared with -> in header.
  Resource automatically closed when scope exits via finally block.

  Tests:
  - Resource initialization before try block
  - Automatic close() call in finally block
  - Exception table with finally handler
-?>
defines module bytecode.test

  defines class

    TestResource

      TestResource()
        -> resourceName as String
        assert resourceName?

      operator close as pure
        stdout <- Stdout()
        stdout.println("Closing resource")

      override operator ? as pure
        <- rtn <- true

  defines program

    @BYTECODE: CODE_GENERATION_AGGREGATES: TYPE: "bytecode.test::TryWithSingleResource":`public class bytecode.test.TryWithSingleResource {
  static {};
    Code:
         0: return

  private void i_init();
    Code:
         0: return

  public bytecode.test.TryWithSingleResource();
    Code:
         0: aload_0
         1: invokespecial #CP                 // Method java/lang/Object."<init>":()V
         4: aload_0
         5: invokevirtual #CP                 // Method i_init:()V
         8: return

  public void _main();
    Code:
         0: aconst_null
         1: astore_1
         2: new           #CP                 // class org/ek9/lang/String
         5: dup
         6: invokespecial #CP                 // Method org/ek9/lang/String."<init>":()V
         9: astore_2
        10: aload_2
        11: astore_1
        12: aconst_null
        13: astore_3
        14: ldc           #CP                 // String test
        16: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
        19: astore        4
        21: new           #CP                 // class bytecode/test/TestResource
        24: dup
        25: aload         4
        27: invokespecial #CP                 // Method bytecode/test/TestResource."<init>":(Lorg/ek9/lang/String;)V
        30: astore        5
        32: aload         5
        34: astore_3
        35: aconst_null
        36: astore        6
        38: ldc           #CP                 // String OK
        40: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
        43: astore        7
        45: aload         7
        47: astore_1
        48: aconst_null
        49: astore        8
        51: new           #CP                 // class org/ek9/lang/Stdout
        54: dup
        55: invokespecial #CP                 // Method org/ek9/lang/Stdout."<init>":()V
        58: astore        9
        60: aload         9
        62: astore        8
        64: aload         8
        66: astore        10
        68: ldc           #CP                 // String Try:
        70: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
        73: astore        11
        75: aload_1
        76: astore        12
        78: aload         11
        80: aload         12
        82: invokevirtual #CP                 // Method org/ek9/lang/String._add:(Lorg/ek9/lang/String;)Lorg/ek9/lang/String;
        85: astore        13
        87: aload         10
        89: aload         13
        91: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
        94: goto          118
        97: astore        14
        99: ldc           #CP                 // String ERROR
       101: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       104: astore        15
       106: aload         15
       108: astore_1
       109: goto          118
       112: athrow
       113: astore        6
       115: goto          118
       118: aload_3
       119: invokevirtual #CP                 // Method bytecode/test/TestResource._close:()V
       122: aload         6
       124: ifnull        130
       127: aload         6
       129: athrow
       130: new           #CP                 // class org/ek9/lang/Stdout
       133: dup
       134: invokespecial #CP                 // Method org/ek9/lang/Stdout."<init>":()V
       137: astore        16
       139: aload         16
       141: astore        8
       143: aload         8
       145: astore        17
       147: ldc           #CP                 // String Result:
       149: invokestatic  #CP                 // Method org/ek9/lang/String._of:(Ljava/lang/String;)Lorg/ek9/lang/String;
       152: astore        18
       154: aload_1
       155: astore        19
       157: aload         18
       159: aload         19
       161: invokevirtual #CP                 // Method org/ek9/lang/String._add:(Lorg/ek9/lang/String;)Lorg/ek9/lang/String;
       164: astore        20
       166: aload         17
       168: aload         20
       170: invokevirtual #CP                 // Method org/ek9/lang/Stdout.println:(Lorg/ek9/lang/String;)V
       173: return
      Exception table:
         from    to  target type
            38    94    97   Class org/ek9/lang/Exception
           118   130   112   Class org/ek9/lang/Exception
            38   112   113   any
}`
    TryWithSingleResource()
      result <- String()

      try
        -> resource <- TestResource("test")
        result: "OK"
        stdout <- Stdout()
        stdout.println("Try: " + result)
      catch
        -> ex as Exception
        result: "ERROR"

      stdout <- Stdout()
      stdout.println("Result: " + result)

//EOF
