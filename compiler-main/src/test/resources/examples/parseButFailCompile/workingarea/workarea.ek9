#!ek9
<?-
  Test for Bug #1 with IMPLICIT finally (try-with-resources)

  This tests that the exception handler registration fix works for IMPLICIT finally blocks
  generated by try-with-resources, not just explicit finally blocks.

  Expected behavior:
  - Resource acquired
  - Exception thrown in try block
  - Resource close() executes (implicit finally)
  - Catch block catches the exception
-?>
defines module exceptionHandling

  defines class

    TestResource
      name as String: String()

      TestResource()
        -> resourceName as String
        name: resourceName

      operator close as pure
        stdout <- Stdout()
        stdout.println("Resource close() executing for: " + name)

      override operator ? as pure
        <- rtn <- true

  defines function

    testImplicitFinally()
      <- rtn as String: String()

      stdout <- Stdout()

      try
        ->
          resource <- TestResource("test-resource")
        stdout.println("Try block: throwing exception")
        ex <- Exception("test exception")
        throw ex
      catch
        -> ex as Exception
        stdout.println("Catch block: caught exception")

      rtn: "Complete"

//EOF
