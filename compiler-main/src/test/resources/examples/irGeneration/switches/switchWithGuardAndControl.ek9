#!ek9
<?-
  Test IR generation for switch with guard + control expression (Form #3).
  Pattern: switch guard <- expression() then controlExpression

  Key difference from guard-only form:
  - Guard declares variable (opt)
  - Control expression specifies what to switch on (opt.get())
  - Guard variable != switch expression
-?>
defines module controlFlow.guardControl

  defines function

    getOptionalValue()
      <- rtn <- Optional("test")

    @IR: IR_GENERATION: FUNCTION: "controlFlow.guardControl::switchWithGuardAndControl": `
    ConstructDfn: controlFlow.guardControl::switchWithGuardAndControl()->org.ek9.lang::String
    OperationDfn: controlFlow.guardControl::switchWithGuardAndControl.c_init()->org.ek9.lang::Void
    BasicBlock: _entry_1
    RETURN
    OperationDfn: controlFlow.guardControl::switchWithGuardAndControl.i_init()->org.ek9.lang::Void
    BasicBlock: _entry_1
    RETURN
    OperationDfn: controlFlow.guardControl::switchWithGuardAndControl.switchWithGuardAndControl()->controlFlow.guardControl::switchWithGuardAndControl
    BasicBlock: _entry_1
    CALL (controlFlow.guardControl::switchWithGuardAndControl)this.i_init() [pure=false, complexity=0]
    RETURN this
    OperationDfn: controlFlow.guardControl::switchWithGuardAndControl._call()->org.ek9.lang::String
    BasicBlock: _entry_1
    SCOPE_ENTER _scope_1
    REFERENCE result, org.ek9.lang::String
    _temp1 = CALL (org.ek9.lang::String)org.ek9.lang::String.<init>() [pure=true, complexity=1, effects=RETURN_MUTATION]
    RETAIN _temp1
    SCOPE_REGISTER _temp1, _scope_1
    STORE result, _temp1
    RETAIN result
    SCOPE_ENTER _scope_2
    REFERENCE opt, org.ek9.lang::_Optional_C011A3DC69C147B21BB3B4318CD6E648E5B36284DE9A0658F8CDDD33D8C1B5BC
    _temp4 = FUNCTION_INSTANCE controlFlow.guardControl::getOptionalValue
    _temp2 = CALL (controlFlow.guardControl::getOptionalValue)_temp4._call() [pure=false, complexity=1, effects=RETURN_MUTATION]
    RETAIN _temp2
    SCOPE_REGISTER _temp2, _scope_2
    STORE opt, _temp2
    RETAIN opt
    SCOPE_REGISTER opt, _scope_2
    _temp6 = LOAD opt
    RETAIN _temp6
    SCOPE_REGISTER _temp6, _scope_2
    _temp5 = CALL (org.ek9.lang::_Optional_C011A3DC69C147B21BB3B4318CD6E648E5B36284DE9A0658F8CDDD33D8C1B5BC)_temp6.get() [pure=true, complexity=0, effects=RETURN_MUTATION]
    RETAIN _temp5
    SCOPE_REGISTER _temp5, _scope_2
    CONTROL_FLOW_CHAIN
    [
    chain_type: "SWITCH_WITH_GUARDS"
    evaluation_variable: _temp5
    evaluation_variable_type: "org.ek9.lang::String"
    condition_chain:
    [
    [
    case_scope_id: _scope_4
    case_type: "LITERAL"
    condition_evaluation:
    [
    SCOPE_ENTER _scope_3
    _temp7 = LOAD _temp5
    RETAIN _temp7
    SCOPE_REGISTER _temp7, _scope_3
    _temp8 = LOAD_LITERAL test, org.ek9.lang::String
    RETAIN _temp8
    SCOPE_REGISTER _temp8, _scope_3
    _temp9 = CALL (org.ek9.lang::String)_temp7._eq(_temp8) [pure=true, complexity=2, effects=RETURN_MUTATION]
    RETAIN _temp9
    SCOPE_REGISTER _temp9, _scope_3
    _temp10 = CALL (org.ek9.lang::Boolean)_temp9._true() [pure=true, complexity=0]
    SCOPE_EXIT _scope_3
    ]
    condition_result: _temp9
    primitive_condition: _temp10
    body_evaluation:
    [
    SCOPE_ENTER _scope_4
    _temp11 = LOAD_LITERAL Found test, org.ek9.lang::String
    RETAIN _temp11
    SCOPE_REGISTER _temp11, _scope_4
    RELEASE result
    STORE result, _temp11
    RETAIN result
    SCOPE_EXIT _scope_4
    ]
    ],
    [
    case_scope_id: _scope_6
    case_type: "LITERAL"
    condition_evaluation:
    [
    SCOPE_ENTER _scope_5
    _temp12 = LOAD _temp5
    RETAIN _temp12
    SCOPE_REGISTER _temp12, _scope_5
    _temp13 = LOAD_LITERAL other, org.ek9.lang::String
    RETAIN _temp13
    SCOPE_REGISTER _temp13, _scope_5
    _temp14 = CALL (org.ek9.lang::String)_temp12._eq(_temp13) [pure=true, complexity=2, effects=RETURN_MUTATION]
    RETAIN _temp14
    SCOPE_REGISTER _temp14, _scope_5
    _temp15 = CALL (org.ek9.lang::Boolean)_temp14._true() [pure=true, complexity=0]
    SCOPE_EXIT _scope_5
    ]
    condition_result: _temp14
    primitive_condition: _temp15
    body_evaluation:
    [
    SCOPE_ENTER _scope_6
    _temp16 = LOAD_LITERAL Found other, org.ek9.lang::String
    RETAIN _temp16
    SCOPE_REGISTER _temp16, _scope_6
    RELEASE result
    STORE result, _temp16
    RETAIN result
    SCOPE_EXIT _scope_6
    ]
    ]
    ]
    default_body_evaluation:
    [
    SCOPE_ENTER _scope_7
    _temp17 = LOAD_LITERAL Not found, org.ek9.lang::String
    RETAIN _temp17
    SCOPE_REGISTER _temp17, _scope_7
    RELEASE result
    STORE result, _temp17
    RETAIN result
    SCOPE_EXIT _scope_7
    ]
    scope_id: _scope_2
    ]
    SCOPE_EXIT _scope_2
    SCOPE_EXIT _scope_1
    RETURN result`
    switchWithGuardAndControl()
      <- result <- String()

      switch opt <- getOptionalValue() then opt.get()
        case "test"
          result := "Found test"
        case "other"
          result := "Found other"
        default
          result := "Not found"

//EOF
